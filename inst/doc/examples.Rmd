---
title: "hpgltools examples"
author: "atb abelew@gmail.com"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{hpgltools examples}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


# Example hpgltool usage with a real data set (fission)

This document aims to provide further examples in how to use the hpgltools.

## Setting up

Here are the commands I invoke to get ready to play with new data, including everything
required to install hpgltools, the software it uses, and the fission data.

```{r setup}

## These first 4 lines are not needed once hpgltools is installed.
##source("http://bioconductor.org/biocLite.R")
##biocLite("devtools")
##library(devtools)
##install_github("elsayed-lab/hpgltools")
library(hpgltools)
autoloads_all()
require.auto("fission")
library(fission)
data(fission)
opts_knit$set(progress=TRUE, verbose=TRUE, error=TRUE,  fig.width=7, fig.height=7)


```

## Data import

All the work I do in Dr. El-Sayed's lab makes some pretty hard assumptions about how data is stored.
As a result, to use the fission data set I will do a little bit of shenanigans to match it to the
expected format.  Now that I have played a little with fission, I think its format is quite nice
and am likely to have my experiment class instead be a SummarizedExperiment.

```{r data_import}

## Extract the meta data from the fission dataset
meta = as.data.frame(fission@colData)
## Make conditions and batches
meta$condition = paste(meta$strain, meta$minute, sep=".")
meta$batch = meta$replicate
meta$sample.id = rownames(meta)
## Write it out in the format expected by my toys
write.csv(meta, file="fission.csv")
## Grab the count data
fission_data = fission@assays$data$counts
## This will make an experiment superclass called 'expt' and it contains
## an ExpressionSet along with any arbitrary additional information one might want to include.
## Along the way it writes a Rdata file which is by default called 'expt.Rdata'
fission_expt = create_expt("fission.csv", count_dataframe=fission_data)

```

## Normalizing and exploring data

There are lots of toys we have learned to use to play with with raw data and explore stuff like
batch effects or non-canonical distributions or skewed counts.  hpgltools provides some functionality
to make this process easier.  The graphs shown below and many more are generated with the wrapper
'graph_metrics()' but that takes away the chance to explain the graphs as I generate them.

```{r norm_explore}

## First make a bar plot of the library sizes in the experiment.
## Notice that the colors were auto-chosen by create_expt() and they should
## be maintained throughout this process
fis_libsize = hpgl_libsize(fission_expt)
fis_libsize

## Here we see that the wild type replicate 3 sample for 15 minutes has fewer non-zero genes than all its friends.
fis_nonzero = hpgl_nonzero(fission_expt, labels="boring", title="nonzero vs. cpm")
fis_nonzero

```

### An initial pca plot

In most cases, raw data does not cluster very well, lets see if that is also true for the fission experiment.
Assuming it doesn't, lets normalize the data using the defaults (cpm, quantile, log2) and try again.

```{r pca}

## Unsurprisingly, the raw data doesn't cluster well at all...
fis_rawpca = hpgl_pca(fission_expt, labels=fission_expt$condition)
fis_rawpca$plot

## So, normalize the data
norm_expt = normalize_expt(fission_expt)
## And try the pca again
fis_normpca = hpgl_pca(norm_expt, labels=norm_expt$condition)
fis_normpca$plot
## ok, that caused the 0, 60, 15, and 30 minute samples to cluster nicely
## the 120 and 180 minute samples are still a bit tight

## pca_information provides some more information about the call to
## fast.svd that went into making the pca plot
fis_data = exprs(norm_expt$expressionset)
fis_info = pca_information(fis_data, design=norm_expt$design, factors=c("condition","batch"), num_components=4)
## The r^2 table shows that quite a lot of the variance in the data is explained by condition
head(fis_info$rsquared_table)
## We can look at the correlation between the principle components and the factors in the experiment
## in this case looking at condition/batch vs the first 4 components.
fis_info$pca_cor
## And p-values to lend some credence(or not to those assertions)
fis_info$anova_p

```
